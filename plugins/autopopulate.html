
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Mongoose Plugins Search</title>
    <link rel="stylesheet" href="/public/style.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700">

    <script type="text/javascript">
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function() {};
      xhr.send(JSON.stringify({
        path: window.location.pathname,
        hostname: window.location.hostname,
        hash: window.location.hash
      }));
    </script>
  </head>
  <body>
    <div id="wrap">
      
    <script type="text/javascript" src="/public/native.js"></script>
    <link rel="stylesheet" href="/public/inlinecpc.css">
    <link rel="stylesheet" href="/public/highlight.css">
    <link rel="stylesheet" href="/public/plugin.css">
    <style>
      a, a:visited {
        color: #0366d6;
      }
    </style>

    <script>
      _native.init("CK7DT53Y",{
        targetClass: 'native-inline'
      });
    </script>

    <div class="content">
      <div class="toc desktop">
        <h2><a href="/">Mongoose Plugins</a></h2>
        <div>
          <div id="select-plugin"><a class="select-plugin-this-repo" href="./autopopulate">mongoose-autopopulate</a> <span class="right-arrow"></span><div id="select-plugin-hidden"><a href="./lean-virtuals">mongoose-lean-virtuals</a>
<a href="./int32">mongoose-int32</a>
<a href="./double">mongoose-double</a>
<a href="./update-versioning">mongoose-update-versioning</a>
<a href="./lean-getters">mongoose-lean-getters</a></div></div>
        </div>
        <ul>
<li><a href="#usage">Usage</a></li>
<li><a href="#mongoose-autopopulate-plugin">mongoose-autopopulate plugin</a><ul>
<li><a href="#it-supports-an-autopopulate-option-in-schemas">It supports an autopopulate option in schemas</a></li>
<li><a href="#it-supports-document-arrays">It supports document arrays</a></li>
<li><a href="#it-has-a-couple-caveats-with-projections">It has a couple caveats with projections</a></li>
<li><a href="#it-can-specify-an-options-argument">It can specify an options argument</a></li>
<li><a href="#it-can-specify-a-function-that-returns-options">It can specify a function that returns options</a></li>
<li><a href="#it-can-disable-autopopulate-for-individual-queries">It can disable autopopulate for individual queries</a></li>
<li><a href="#it-can-disable-autopopulate-in-populate-options">It can disable autopopulate in <code>populate()</code> options</a></li>
<li><a href="#it-requires-an-option-to-work-with-lean">It requires an option to work with lean</a></li>
<li><a href="#it-can-limit-the-depth-using-maxdepth">It can limit the depth using <code>maxDepth</code></a></li>
<li><a href="#it-can-pass-a-list-or-regular-expression-of-functions-to-apply-hooks-to">It can pass a list or regular expression of functions to apply hooks to</a></li>
</ul>
</li>
<li><a href="#changelog">Changelog</a><ul>
<li><a href="#100--2023-02-27">1.0.0 / 2023-02-27</a></li>
<li><a href="#100-rc0--2023-02-24">1.0.0-rc0 / 2023-02-24</a></li>
<li><a href="#0171--2022-01-03">0.17.1 / 2022-01-03</a></li>
<li><a href="#0170--2022-12-28">0.17.0 / 2022-12-28</a></li>
<li><a href="#0161--2022-04-04">0.16.1 / 2022-04-04</a></li>
<li><a href="#0160--2021-09-22">0.16.0 / 2021-09-22</a></li>
<li><a href="#0150--2021-09-06">0.15.0 / 2021-09-06</a></li>
<li><a href="#0140--2021-05-14">0.14.0 / 2021-05-14</a></li>
<li><a href="#0130--2021-04-15">0.13.0 / 2021-04-15</a></li>
<li><a href="#0122--2020-04-19">0.12.2 / 2020-04-19</a></li>
<li><a href="#0121--2020-03-29">0.12.1 / 2020-03-29</a></li>
<li><a href="#0120--2020-02-05">0.12.0 / 2020-02-05</a></li>
<li><a href="#0110--2020-01-24">0.11.0 / 2020-01-24</a></li>
<li><a href="#0100--2019-12-20">0.10.0 / 2019-12-20</a></li>
<li><a href="#091--2019-01-02">0.9.1 / 2019-01-02</a></li>
<li><a href="#090--2018-11-08">0.9.0 / 2018-11-08</a></li>
<li><a href="#082--2018-10-10">0.8.2 / 2018-10-10</a></li>
<li><a href="#081--2018-09-02">0.8.1 / 2018-09-02</a></li>
<li><a href="#080--2018-07-01">0.8.0 / 2018-07-01</a></li>
<li><a href="#070--2018-05-10">0.7.0 / 2018-05-10</a></li>
<li><a href="#050--2016-11-29">0.5.0 / 2016-11-29</a></li>
<li><a href="#040--2015-09-03">0.4.0 / 2015-09-03</a></li>
<li><a href="#030--2015-07-30">0.3.0 / 2015-07-30</a></li>
<li><a href="#020--2015-06-27">0.2.0 / 2015-06-27</a></li>
</ul>
</li>
</ul>

        <div id="carbonads-wrapper">
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DT537&placement=mongoosejsio" id="_carbonads_js"></script>
        </div>
      </div>
      <h1 id="repo" class="desktop">mongoose-autopopulate</h1>
      <div class="toc mobile">
        <h2><a href="/">Mongoose Plugins</a></h2>
        <div>
          <select id="select-plugin-mobile" onchange="window.location.href = '/plugins/' + this.value">
      <option value="autopopulate" selected>
        mongoose-autopopulate
      </option>
    

      <option value="lean-virtuals" >
        mongoose-lean-virtuals
      </option>
    

      <option value="int32" >
        mongoose-int32
      </option>
    

      <option value="double" >
        mongoose-double
      </option>
    

      <option value="update-versioning" >
        mongoose-update-versioning
      </option>
    

      <option value="lean-getters" >
        mongoose-lean-getters
      </option>
    </select>
        </div>
        <ul>
<li><a href="#usage">Usage</a></li>
<li><a href="#mongoose-autopopulate-plugin">mongoose-autopopulate plugin</a><ul>
<li><a href="#it-supports-an-autopopulate-option-in-schemas">It supports an autopopulate option in schemas</a></li>
<li><a href="#it-supports-document-arrays">It supports document arrays</a></li>
<li><a href="#it-has-a-couple-caveats-with-projections">It has a couple caveats with projections</a></li>
<li><a href="#it-can-specify-an-options-argument">It can specify an options argument</a></li>
<li><a href="#it-can-specify-a-function-that-returns-options">It can specify a function that returns options</a></li>
<li><a href="#it-can-disable-autopopulate-for-individual-queries">It can disable autopopulate for individual queries</a></li>
<li><a href="#it-can-disable-autopopulate-in-populate-options">It can disable autopopulate in <code>populate()</code> options</a></li>
<li><a href="#it-requires-an-option-to-work-with-lean">It requires an option to work with lean</a></li>
<li><a href="#it-can-limit-the-depth-using-maxdepth">It can limit the depth using <code>maxDepth</code></a></li>
<li><a href="#it-can-pass-a-list-or-regular-expression-of-functions-to-apply-hooks-to">It can pass a list or regular expression of functions to apply hooks to</a></li>
</ul>
</li>
<li><a href="#changelog">Changelog</a><ul>
<li><a href="#100--2023-02-27">1.0.0 / 2023-02-27</a></li>
<li><a href="#100-rc0--2023-02-24">1.0.0-rc0 / 2023-02-24</a></li>
<li><a href="#0171--2022-01-03">0.17.1 / 2022-01-03</a></li>
<li><a href="#0170--2022-12-28">0.17.0 / 2022-12-28</a></li>
<li><a href="#0161--2022-04-04">0.16.1 / 2022-04-04</a></li>
<li><a href="#0160--2021-09-22">0.16.0 / 2021-09-22</a></li>
<li><a href="#0150--2021-09-06">0.15.0 / 2021-09-06</a></li>
<li><a href="#0140--2021-05-14">0.14.0 / 2021-05-14</a></li>
<li><a href="#0130--2021-04-15">0.13.0 / 2021-04-15</a></li>
<li><a href="#0122--2020-04-19">0.12.2 / 2020-04-19</a></li>
<li><a href="#0121--2020-03-29">0.12.1 / 2020-03-29</a></li>
<li><a href="#0120--2020-02-05">0.12.0 / 2020-02-05</a></li>
<li><a href="#0110--2020-01-24">0.11.0 / 2020-01-24</a></li>
<li><a href="#0100--2019-12-20">0.10.0 / 2019-12-20</a></li>
<li><a href="#091--2019-01-02">0.9.1 / 2019-01-02</a></li>
<li><a href="#090--2018-11-08">0.9.0 / 2018-11-08</a></li>
<li><a href="#082--2018-10-10">0.8.2 / 2018-10-10</a></li>
<li><a href="#081--2018-09-02">0.8.1 / 2018-09-02</a></li>
<li><a href="#080--2018-07-01">0.8.0 / 2018-07-01</a></li>
<li><a href="#070--2018-05-10">0.7.0 / 2018-05-10</a></li>
<li><a href="#050--2016-11-29">0.5.0 / 2016-11-29</a></li>
<li><a href="#040--2015-09-03">0.4.0 / 2015-09-03</a></li>
<li><a href="#030--2015-07-30">0.3.0 / 2015-07-30</a></li>
<li><a href="#020--2015-06-27">0.2.0 / 2015-06-27</a></li>
</ul>
</li>
</ul>

      </div>
      <div class="native-inline">
        <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# â€” #native_desc#</a>
      </div>
      <h1 id="usage">Usage</h1>
<p>The <code>mongoose-autopopulate</code> module exposes a single function that you can
pass to <a href="https://mongoosejs.com/docs/api.html#schema_Schema-plugin">Mongoose schema&#39;s <code>plugin()</code> function</a>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> mongoose.Schema({
  <span class="hljs-attr">populatedField</span>: {
    <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
    <span class="hljs-attr">ref</span>: <span class="hljs-string">'ForeignModel'</span>,
    <span class="hljs-comment">// The below option tells this plugin to always call `populate()` on</span>
    <span class="hljs-comment">// `populatedField`</span>
    autopopulate: <span class="hljs-literal">true</span>
  }
});
schema.plugin(<span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose-autopopulate'</span>));</code></pre>
<p>Only apply this plugin to top-level schemas. Don&#39;t apply this plugin to child schemas.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Don't do `nestedSchema.plugin(require('mongoose-autopopulate'))`.</span>
<span class="hljs-comment">// You only need to add mongoose-autopopulate to top-level schemas.</span>
<span class="hljs-keyword">const</span> nestedSchema = mongoose.Schema({
  <span class="hljs-attr">child</span>: { <span class="hljs-attr">type</span>: <span class="hljs-built_in">Number</span>, <span class="hljs-attr">ref</span>: <span class="hljs-string">'Child'</span>, <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">true</span> }
});
<span class="hljs-keyword">const</span> topSchema = mongoose.Schema({ <span class="hljs-attr">nested</span>: nestedSchema });
topSchema.plugin(<span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose-autopopulate'</span>));</code></pre>


      

<h1 id="mongoose-autopopulate-plugin">mongoose-autopopulate plugin</h1>


<h2 id="it-supports-an-autopopulate-option-in-schemas">It supports an autopopulate option in schemas</h2>
<p>Suppose you have two collections, &quot;people&quot; and &quot;bands&quot;. The <code>People</code> model
looks like this:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> personSchema = <span class="hljs-keyword">new</span> Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>, <span class="hljs-attr">birthName</span>: <span class="hljs-built_in">String</span> });
Person = mongoose.model(<span class="hljs-string">'people'</span>, personSchema, <span class="hljs-string">'people'</span>);</code></pre>
<p>Suppose your &quot;people&quot; collection has one document:</p>
<pre><code class="language-javascript">{
<span class="hljs-attr">name</span>: <span class="hljs-string">'Axl Rose'</span>,
<span class="hljs-attr">birthName</span>: <span class="hljs-string">'William Bruce Rose, Jr.'</span>,
<span class="hljs-attr">_id</span>: <span class="hljs-string">'54ef3f374849dcaa649a3abc'</span>
};</code></pre>
<p>And your &quot;bands&quot; collection has one document:</p>
<pre><code class="language-javascript">{
<span class="hljs-attr">_id</span>: <span class="hljs-string">'54ef3f374849dcaa649a3abd'</span>,
<span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span>,
<span class="hljs-attr">lead</span>: <span class="hljs-string">'54ef3f374849dcaa649a3abc'</span>,
<span class="hljs-attr">members</span>: [<span class="hljs-string">'54ef3f374849dcaa649a3abc'</span>]
}</code></pre>
<p>You can set the <code>autopopulate</code> option for the <code>lead</code> field.
This means that, every time you call <code>find()</code> or <code>findOne()</code>,
<code>mongoose-autopopulate</code> will automatically call <code>.populate(&#39;lead&#39;)</code>
for you.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> bandSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">lead</span>: { <span class="hljs-attr">type</span>: ObjectId, <span class="hljs-attr">ref</span>: <span class="hljs-string">'people'</span>, <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">true</span> }
});
bandSchema.plugin(autopopulate);

<span class="hljs-keyword">var</span> Band = mongoose.model(<span class="hljs-string">'band3'</span>, bandSchema, <span class="hljs-string">'bands'</span>);
Band.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, doc</span>) </span>{
  assert.ifError(error);
  assert.equal(<span class="hljs-string">'Axl Rose'</span>, doc.lead.name);
  assert.equal(<span class="hljs-string">'William Bruce Rose, Jr.'</span>, doc.lead.birthName);
  done();
});</code></pre>


<h2 id="it-supports-document-arrays">It supports document arrays</h2>
<p><code>mongoose-autopopulate</code> also works on arrays.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> bandSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">members</span>: [{ <span class="hljs-attr">type</span>: ObjectId, <span class="hljs-attr">ref</span>: <span class="hljs-string">'people'</span>, <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">true</span> }]
});
bandSchema.plugin(autopopulate);

<span class="hljs-keyword">var</span> Band = mongoose.model(<span class="hljs-string">'band4'</span>, bandSchema, <span class="hljs-string">'bands'</span>);
Band.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, doc</span>) </span>{
  assert.ifError(error);
  assert.equal(<span class="hljs-string">'Axl Rose'</span>, doc.members[<span class="hljs-number">0</span>].name);
  assert.equal(<span class="hljs-string">'William Bruce Rose, Jr.'</span>, doc.members[<span class="hljs-number">0</span>].birthName);
  done();
});</code></pre>


<h2 id="it-has-a-couple-caveats-with-projections">It has a couple caveats with projections</h2>
<p>By default, Mongoose 5.x automatically projects in populated properties.
That means you need a little extra work to exclude autopopulated fields.
Either explicitly <a href="https://mongoosejs.com/docs/api.html#query_Query-select">deselect the path</a>
in your projection, or set the <a href="https://mongoosejs.com/docs/guide.html#selectPopulatedPaths"><code>selectPopulatedPaths</code> schema option</a>
to <code>false</code>.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Mongoose adds `members: 1` and `lead: 1` to the projection</span>
<span class="hljs-keyword">let</span> band = <span class="hljs-keyword">yield</span> Band.findOne().select({ <span class="hljs-attr">name</span>: <span class="hljs-number">1</span> });
assert.equal(band.members[<span class="hljs-number">0</span>].name, <span class="hljs-string">'Axl Rose'</span>);
assert.equal(band.lead.name, <span class="hljs-string">'Axl Rose'</span>);

<span class="hljs-comment">// You can also tell Mongoose to not project in populated paths by default</span>
<span class="hljs-comment">// using the `selectPopulatedPaths` schema option.</span>
<span class="hljs-keyword">const</span> newSchema = Band.schema.clone();

newSchema.options.selectPopulatedPaths = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> Band2 = mongoose.model(<span class="hljs-string">'Band2'</span>, newSchema, <span class="hljs-string">'bands'</span>);

band = <span class="hljs-keyword">yield</span> Band2.findOne().select({ <span class="hljs-attr">name</span>: <span class="hljs-number">1</span> });
assert.ok(!band.members);
assert.ok(!band.lead);</code></pre>


<h2 id="it-can-specify-an-options-argument">It can specify an options argument</h2>
<p>Advanced users of <code>populate()</code> may want to specify additional
options, such as selecting fields. If you set the <code>autopopulate</code>
option to an object, <code>mongoose-autopopulate</code> will merge the object
into populate options. The <code>findOne()</code> below is equivalent to
<code>Band.findOne({ name: &quot;Guns N&#39; Roses&quot; }).populate({ path: &#39;lead&#39;, select: &#39;name });</code></p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> bandSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">lead</span>: { <span class="hljs-attr">type</span>: ObjectId, <span class="hljs-attr">ref</span>: <span class="hljs-string">'people'</span>, <span class="hljs-attr">autopopulate</span>: { <span class="hljs-attr">select</span>: <span class="hljs-string">'name'</span> } }
});
bandSchema.plugin(autopopulate);

<span class="hljs-keyword">var</span> Band = mongoose.model(<span class="hljs-string">'band5'</span>, bandSchema, <span class="hljs-string">'bands'</span>);
Band.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, doc</span>) </span>{
  assert.ifError(error);
  assert.equal(<span class="hljs-string">'Axl Rose'</span>, doc.lead.name);
  assert.ok(!doc.lead.birthName);
  done();
});</code></pre>


<h2 id="it-can-specify-a-function-that-returns-options">It can specify a function that returns options</h2>
<p>You can also set the <code>autopopulate</code> option to be a function.
Then <code>mongoose-autopopulate</code> will call the function with
the query object as the context and use the return value.
The below <code>populate()</code> uses the same options as the previous
example.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> numCalls = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> optionsFunction = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  ++numCalls;
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">select</span>: <span class="hljs-string">'name'</span> };
};

<span class="hljs-keyword">var</span> bandSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">lead</span>: { <span class="hljs-attr">type</span>: ObjectId, <span class="hljs-attr">ref</span>: <span class="hljs-string">'people'</span>, <span class="hljs-attr">autopopulate</span>: optionsFunction }
});
bandSchema.plugin(autopopulate);

<span class="hljs-keyword">var</span> Band = mongoose.model(<span class="hljs-string">'band6'</span>, bandSchema, <span class="hljs-string">'bands'</span>);
Band.find({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, docs</span>) </span>{
  assert.ifError(error);
  assert.equal(<span class="hljs-number">1</span>, docs.length);
  assert.equal(<span class="hljs-number">1</span>, numCalls);
  <span class="hljs-keyword">var</span> doc = docs[<span class="hljs-number">0</span>];
  assert.equal(<span class="hljs-string">'Axl Rose'</span>, doc.lead.name);
  assert.ok(!doc.lead.birthName);
  done();
});</code></pre>


<h2 id="it-can-disable-autopopulate-for-individual-queries">It can disable autopopulate for individual queries</h2>
<p>If you set the <code>autopopulate</code> option to <code>false</code> on a query, autopopulate
will be disabled. This is handy if you want to autopopulate by default,
but opt-out for special cases.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> bandSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">lead</span>: { <span class="hljs-attr">type</span>: ObjectId, <span class="hljs-attr">ref</span>: <span class="hljs-string">'people'</span>, <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">true</span> }
});
bandSchema.plugin(autopopulate);

<span class="hljs-keyword">var</span> Band = mongoose.model(<span class="hljs-string">'band7'</span>, bandSchema, <span class="hljs-string">'bands'</span>);
Band.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> }, {}, { <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">false</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, doc</span>) </span>{
  assert.ifError(error);
  assert.ok(doc.lead <span class="hljs-keyword">instanceof</span> mongoose.Types.ObjectId);
  assert.ok(!doc.populated(<span class="hljs-string">'lead'</span>));
  done();
});</code></pre>


<h2 id="it-can-disable-autopopulate-in-populate-options">It can disable autopopulate in <code>populate()</code> options</h2>
<p>Say you have a model <code>User</code> that has the autopopulate plugin and you&#39;re
populating users from a different model. To disable autopopulate, you
need to set <code>autopopulate: false</code> as a populate option, not a query
option.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
  <span class="hljs-attr">friends</span>: [{
    <span class="hljs-attr">type</span>: Schema.Types.ObjectId,
    <span class="hljs-attr">ref</span>: <span class="hljs-string">'User'</span>,
    <span class="hljs-attr">autopopulate</span>: { <span class="hljs-attr">maxDepth</span>: <span class="hljs-number">2</span> }
  }]
});
userSchema.plugin(autopopulate);

<span class="hljs-keyword">const</span> responseSchema = <span class="hljs-keyword">new</span> Schema({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">type</span>: Schema.Types.ObjectId,
    <span class="hljs-attr">ref</span>: <span class="hljs-string">'User'</span>
  }
});

<span class="hljs-keyword">const</span> User = mongoose.model(<span class="hljs-string">'User'</span>, userSchema);
<span class="hljs-keyword">const</span> Response = mongoose.model(<span class="hljs-string">'Response'</span>, responseSchema);

<span class="hljs-keyword">return</span> co(<span class="hljs-function"><span class="hljs-keyword">function</span>*(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> axl = <span class="hljs-keyword">new</span> User({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Axl'</span> });
  <span class="hljs-keyword">const</span> slash = <span class="hljs-keyword">new</span> User({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Slash'</span>, <span class="hljs-attr">friends</span>: [axl._id] });
  axl.friends.push(slash._id);

  <span class="hljs-keyword">yield</span> [axl.save(), slash.save()];
  <span class="hljs-keyword">let</span> r = <span class="hljs-keyword">yield</span> Response.create({ <span class="hljs-attr">user</span>: axl._id });

  r = <span class="hljs-keyword">yield</span> Response.findById(r._id).
    <span class="hljs-comment">// Because `User` is the foreign model, you need to disable autopopulate</span>
    <span class="hljs-comment">// in the populate options below, not the query options</span>
    populate({ <span class="hljs-attr">path</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">options</span>: { <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">false</span> } });
});</code></pre>


<h2 id="it-requires-an-option-to-work-with-lean">It requires an option to work with lean</h2>
<p>Setting the <a href="https://mongoosejs.com/docs/api.html#query_Query-lean">Mongoose <code>lean</code> option</a>
will disable autopopulate for all paths, <em>unless</em> you add <code>autopulate: true</code>
to your <code>lean</code> option.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// acquit:ignore:start</span>
<span class="hljs-keyword">return</span> co(<span class="hljs-function"><span class="hljs-keyword">function</span>*(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// acquit:ignore:end</span>
  <span class="hljs-keyword">let</span> band = <span class="hljs-keyword">yield</span> Band.findOne().lean();
  <span class="hljs-comment">// Won't autopopulate because `lean()` is set</span>
  assert.ok(band.lead <span class="hljs-keyword">instanceof</span> mongoose.Types.ObjectId);

  <span class="hljs-comment">// To turn on `autopopulate` with lean, use `lean({ autopulate: true })`</span>
  band = <span class="hljs-keyword">yield</span> Band.findOne().lean({ <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">true</span> });
  assert.equal(band.lead.name, <span class="hljs-string">'Axl Rose'</span>);</code></pre>


<h2 id="it-can-limit-the-depth-using-maxdepth">It can limit the depth using <code>maxDepth</code></h2>
<p>Recursive populate can lead to messy infinite recursion, so this plugin
supports a <code>maxDepth</code> option that limits how deep recursive population
will go. The <code>maxDepth</code> option is 10 by default</p>
<pre><code class="language-javascript"><span class="hljs-keyword">return</span> co(<span class="hljs-function"><span class="hljs-keyword">function</span>*(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> accountSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">friends</span>: [{
      <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
      <span class="hljs-attr">ref</span>: <span class="hljs-string">'Account'</span>,
      <span class="hljs-comment">// This is a recursive relationship, `friends` points to a list</span>
      <span class="hljs-comment">// of accounts. If we didn't limit the depth, this would result</span>
      <span class="hljs-comment">// in infinite recursion!</span>
      autopopulate: { <span class="hljs-attr">maxDepth</span>: <span class="hljs-number">2</span> }
    }]
  });
  accountSchema.plugin(autopopulate);

  <span class="hljs-keyword">const</span> Account = mongoose.model(<span class="hljs-string">'Account'</span>, accountSchema);

  <span class="hljs-keyword">const</span> axl = <span class="hljs-keyword">new</span> Account({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Axl'</span> });
  <span class="hljs-keyword">const</span> slash = <span class="hljs-keyword">new</span> Account({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Slash'</span>, <span class="hljs-attr">friends</span>: [axl._id] });
  axl.friends.push(slash._id);

  <span class="hljs-keyword">yield</span> axl.save();
  <span class="hljs-keyword">yield</span> slash.save();

  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">yield</span> Account.findById(axl._id);

  assert.equal(doc.friends[<span class="hljs-number">0</span>].name, <span class="hljs-string">'Slash'</span>);
  assert.equal(doc.friends[<span class="hljs-number">0</span>].friends[<span class="hljs-number">0</span>].name, <span class="hljs-string">'Axl'</span>);
  <span class="hljs-comment">// Only populate 2 levels deep, 3rd level will still be an `_id`</span>
  assert.equal(doc.friends[<span class="hljs-number">0</span>].friends[<span class="hljs-number">0</span>].friends[<span class="hljs-number">0</span>].toString(),
    slash._id.toHexString());
});</code></pre>


<h2 id="it-can-pass-a-list-or-regular-expression-of-functions-to-apply-hooks-to">It can pass a list or regular expression of functions to apply hooks to</h2>
<p>By default, autopopulate applies to the results of <code>find()</code>, <code>findOne()</code>,
<code>findOneAndUpdate()</code>, and <code>save()</code>. You can pick which functions
you want autopopulate to handle using the <code>functions</code> option. For example,
the below code disables autopopulating on <code>save()</code>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">return</span> co(<span class="hljs-function"><span class="hljs-keyword">function</span>*(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> bandSchema = <span class="hljs-keyword">new</span> Schema({
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">lead</span>: { <span class="hljs-attr">type</span>: ObjectId, <span class="hljs-attr">ref</span>: <span class="hljs-string">'people'</span>, <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">true</span> }
  });
  bandSchema.plugin(autopopulate, {
    <span class="hljs-comment">// Apply this plugin to all functions except for `save()`</span>
    functions: [<span class="hljs-string">'find'</span>, <span class="hljs-string">'findOne'</span>, <span class="hljs-string">'findOneAndUpdate'</span>]
  });

  <span class="hljs-keyword">const</span> Band = mongoose.model(<span class="hljs-string">'band8'</span>, bandSchema, <span class="hljs-string">'bands'</span>);

  <span class="hljs-keyword">let</span> band = <span class="hljs-keyword">yield</span> Band.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> });
  assert.ok(band.populated(<span class="hljs-string">'lead'</span>));

  band = <span class="hljs-keyword">yield</span> Band.findOne({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Guns N' Roses"</span> }).setOptions({ <span class="hljs-attr">autopopulate</span>: <span class="hljs-literal">false</span> });
  assert.ok(!band.populated(<span class="hljs-string">'lead'</span>));
  <span class="hljs-comment">// `save()` doesn't autopopulate</span>
  <span class="hljs-keyword">yield</span> band.save();
  assert.ok(!band.populated(<span class="hljs-string">'lead'</span>));
});</code></pre>


      <h1 id="changelog">Changelog</h1>
<h2 id="100--2023-02-27">1.0.0 / 2023-02-27</h2>
<ul>
<li>feat: support mongoose 7</li>
</ul>
<h2 id="100-rc0--2023-02-24">1.0.0-rc0 / 2023-02-24</h2>
<ul>
<li>feat: support mongoose 7</li>
</ul>
<h2 id="0171--2022-01-03">0.17.1 / 2022-01-03</h2>
<ul>
<li>fix: handle infinite schema recursion #106 #101 <a href="https://github.com/IslandRhythms">IslandRhythms</a></li>
</ul>
<h2 id="0170--2022-12-28">0.17.0 / 2022-12-28</h2>
<ul>
<li>feat: add support for nested autopopulated virtuals #105 #104 <a href="https://github.com/Danchoys">Danchoys</a></li>
</ul>
<h2 id="0161--2022-04-04">0.16.1 / 2022-04-04</h2>
<ul>
<li>fix: support subdocuments in Mongoose 6.1.x #94</li>
</ul>
<h2 id="0160--2021-09-22">0.16.0 / 2021-09-22</h2>
<ul>
<li>feat: add native type definitions #92 #91 <a href="https://github.com/TheVaan">TheVaan</a></li>
</ul>
<h2 id="0150--2021-09-06">0.15.0 / 2021-09-06</h2>
<ul>
<li>BREAKING CHANGE: use Mongoose 6, drop support for Mongoose 5 #89 #88</li>
</ul>
<h2 id="0140--2021-05-14">0.14.0 / 2021-05-14</h2>
<ul>
<li>feat: add <code>functions</code> option to list out functions to register hooks on</li>
</ul>
<h2 id="0130--2021-04-15">0.13.0 / 2021-04-15</h2>
<ul>
<li>fix: autopopulate nested array fields containing embedded discriminator #82</li>
<li>feat: autopopulate embedded discriminators #82</li>
</ul>
<h2 id="0122--2020-04-19">0.12.2 / 2020-04-19</h2>
<ul>
<li>fix: avoid error in post(&#39;save&#39;) handler when this plugin is registered on a child schema #10</li>
<li>docs: explain that this plugin should only be registered on top-level schemas</li>
</ul>
<h2 id="0121--2020-03-29">0.12.1 / 2020-03-29</h2>
<ul>
<li>fix: handle autopopulate within nested document array when top-level array is empty #70</li>
</ul>
<h2 id="0120--2020-02-05">0.12.0 / 2020-02-05</h2>
<ul>
<li>feat: autopopulate discriminators post <code>find()</code>, <code>findOne()</code>, and <code>findOneAndUpdate()</code> #26</li>
</ul>
<h2 id="0110--2020-01-24">0.11.0 / 2020-01-24</h2>
<ul>
<li>feat: allow override of maxDepth param via query options #62 <a href="https://github.com/jmikrut">jmikrut</a></li>
</ul>
<h2 id="0100--2019-12-20">0.10.0 / 2019-12-20</h2>
<ul>
<li>feat: autopopulate paths after <code>save()</code> if they aren&#39;t already populated #8</li>
</ul>
<h2 id="091--2019-01-02">0.9.1 / 2019-01-02</h2>
<ul>
<li>docs: add note about selectPopulatedPaths option #50</li>
</ul>
<h2 id="090--2018-11-08">0.9.0 / 2018-11-08</h2>
<ul>
<li>feat: support turning on autopopulate with lean #48 #27 #14</li>
</ul>
<h2 id="082--2018-10-10">0.8.2 / 2018-10-10</h2>
<ul>
<li>docs: link to new plugins site on plugins.mongoosejs.io</li>
</ul>
<h2 id="081--2018-09-02">0.8.1 / 2018-09-02</h2>
<ul>
<li>fix: call function with options and include refPath in options #15</li>
</ul>
<h2 id="080--2018-07-01">0.8.0 / 2018-07-01</h2>
<ul>
<li>fix: add support for findOneAndUpdate() with autopopulate #42</li>
</ul>
<h2 id="070--2018-05-10">0.7.0 / 2018-05-10</h2>
<ul>
<li>BREAKING CHANGE: drop support for Node.js &lt; 4.0.0</li>
<li>feat: add <code>maxDepth</code> option, set to 10 by default #37 #20 #11</li>
</ul>
<h2 id="050--2016-11-29">0.5.0 / 2016-11-29</h2>
<ul>
<li>feat: support lean #27 #14 <a href="https://github.com/siboulet">siboulet</a></li>
<li>feat: support virtual autopopulate #24 <a href="https://github.com/siboulet">siboulet</a></li>
</ul>
<h2 id="040--2015-09-03">0.4.0 / 2015-09-03</h2>
<ul>
<li>added; support for arrays #9 <a href="https://github.com/rerthal">rerthal</a></li>
</ul>
<h2 id="030--2015-07-30">0.3.0 / 2015-07-30</h2>
<ul>
<li>added; support of autopopulate in nested schemas #5 <a href="https://github.com/eloytoro">eloytoro</a></li>
<li>fixed; changed mongoose peer dependency to 4.x #4</li>
</ul>
<h2 id="020--2015-06-27">0.2.0 / 2015-06-27</h2>
<ul>
<li>added; support for nested schemas #3 <a href="https://github.com/siboulet">siboulet</a></li>
</ul>

    </div>
  
    </div>
  </body>
</html>
